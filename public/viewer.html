<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Relatório — Visualizador</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --brand:#0b57d0;
      --bg:#f7f7f8;
      --ink:#222;
      --muted:#666;
      --card:#ffffff;
      --border:#e7e7ea;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--ink);
      font: 15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .wrap{display:flex;flex-direction:column;min-height:100vh}
    .header{
      background:var(--card);border-bottom:1px solid var(--border);
      padding:12px 16px;display:flex;gap:12px;align-items:center
    }
    .logos{display:flex;gap:10px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:8px;background:#eef;
      display:inline-flex;align-items:center;justify-content:center;
      border:1px solid #dde; overflow:hidden
    }
    .logo img{width:100%;height:100%;object-fit:contain}
    .title{font-weight:700}
    .subtitle{color:var(--muted);font-size:13px}
    .meta{margin-left:auto;font-size:12px;color:var(--muted)}
    .main{flex:1;display:flex;min-height:0}
    iframe{
      border:0; width:100%; height:calc(100vh - 65px); background:#fff;
      border-top:1px solid var(--border);
    }
    .bar{
      padding:6px 16px;background:var(--bg);border-top:1px solid var(--border);
      font-size:12px;color:var(--muted)
    }
    .btn{
      display:inline-block;padding:6px 10px;border-radius:8px;border:1px solid var(--border);
      background:#fff;text-decoration:none;color:var(--ink);font-size:13px
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="logos">
        <div class="logo" id="brand-left"  style="display:none"><img alt="logo"></div>
        <div class="logo" id="brand-right" style="display:none"><img alt="logo"></div>
      </div>
      <div>
        <div class="title"    id="site-title">Correções — Reports</div>
        <div class="subtitle" id="breadcrumb">Relatórios com rubrica</div>
      </div>
      <div class="meta" id="meta"></div>
    </div>

    <div class="main">
      <iframe id="view" src="about:blank" referrerpolicy="no-referrer"></iframe>
    </div>

    <div class="bar">
      <a class="btn" href="/index.html">← Voltar à lista</a>
      <span id="fileName" style="margin-left:12px"></span>
    </div>
  </div>

  <script>
    // Carrega branding.json (preferido). Se não existir, tenta config.json (compat).
    async function loadBranding(){
      let cfg = null;

      async function tryLoad(url){
        const r = await fetch(url, {cache:'no-store'});
        if (r.ok) return r.json();
        return null;
      }

      // 1) Novo formato
      cfg = await tryLoad('/branding/branding.json');

      // 2) Legado (config.json)
      if(!cfg){
        const legacy = await tryLoad('/branding/config.json');
        if(legacy){
          cfg = {
            title: legacy.brandTitle,
            breadcrumb: legacy.brandSubtitle,
            logos: {
              left:  legacy.primaryLogo  || null,
              right: legacy.secondaryLogo|| null
            },
            colors: {
              accent: legacy.accentColor,
              bg:     legacy.background,
              text:   legacy.textColor,
              muted:  legacy.mutedColor,
              card:   legacy.cardColor,
              border: legacy.borderColor
            }
          };
        }
      }

      if(!cfg) return; // mantém os defaults

      // Cores (se houver)
      const colors = cfg.colors || {};
      if(colors.accent) document.documentElement.style.setProperty('--brand',  colors.accent);
      if(colors.bg)     document.documentElement.style.setProperty('--bg',     colors.bg);
      if(colors.text)   document.documentElement.style.setProperty('--ink',    colors.text);
      if(colors.muted)  document.documentElement.style.setProperty('--muted',  colors.muted);
      if(colors.card)   document.documentElement.style.setProperty('--card',   colors.card);
      if(colors.border) document.documentElement.style.setProperty('--border', colors.border);

      // Títulos
      if(cfg.title)     document.getElementById('site-title').textContent = cfg.title;
      if(cfg.breadcrumb)document.getElementById('breadcrumb').textContent = cfg.breadcrumb;

      // Logos
      const leftBox  = document.getElementById('brand-left');
      const rightBox = document.getElementById('brand-right');

      function setLogo(box, url){
        if(url){
          box.style.display = 'inline-flex';
          box.querySelector('img').src = url;
        }else{
          box.style.display = 'none';
          box.querySelector('img').removeAttribute('src');
        }
      }

      setLogo(leftBox,  cfg.logos?.left  || null);
      setLogo(rightBox, cfg.logos?.right || null);
    }

    // Abre ?file=reports/xxx.html no iframe
    function openReportFromQuery(){
      const params = new URLSearchParams(location.search);
      const file = params.get('file');
      const frame = document.getElementById('view');
      const fileNameEl = document.getElementById('fileName');

      if(!file){
        frame.srcdoc = `<div style="padding:24px;font:14px system-ui">
          <h3>Arquivo não informado</h3>
          <p>Use a lista em <a href="/index.html">/index.html</a> para abrir um relatório.</p>
        </div>`;
        return;
      }

      // Nome amigável no rodapé
      try{
        const nice = decodeURIComponent(file).split('/').pop();
        fileNameEl.textContent = 'Arquivo: ' + nice;
      }catch(e){
        fileNameEl.textContent = 'Arquivo: ' + file;
      }

      // Carrega o relatório real
      frame.src = '/' + file.replace(/^\/+/, '');
    }

    // Data/hora no topo
    document.getElementById('meta').textContent = new Date().toLocaleString('pt-BR');

    // Inicialização
    loadBranding().then(openReportFromQuery);
  </script>
</body>
</html>