<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Relatório — Visualizador</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --brand:#0b57d0;
      --bg:#f7f7f8;
      --ink:#222;
      --muted:#666;
      --card:#ffffff;
      --border:#e7e7ea;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--ink);
      font: 15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }
    .wrap{display:flex;flex-direction:column;min-height:100vh}
    .header{
      background:var(--card);border-bottom:1px solid var(--border);
      padding:12px 16px;display:flex;gap:12px;align-items:center
    }
    .logos{display:flex;gap:10px;align-items:center}
    .logo{
      width:44px;height:44px;border-radius:8px;background:#eef;
      display:inline-flex;align-items:center;justify-content:center;
      border:1px solid #dde; overflow:hidden
    }
    .logo img{width:100%;height:100%;object-fit:contain}
    .title{font-weight:700}
    .subtitle{color:var(--muted);font-size:13px}
    .meta{margin-left:auto;font-size:12px;color:var(--muted)}
    .main{flex:1;display:flex;min-height:0}
    iframe{
      border:0; width:100%; height:calc(100vh - 65px); background:#fff;
      border-top:1px solid var(--border);
    }
    .bar{
      padding:6px 16px;background:var(--bg);border-top:1px solid var(--border);
      font-size:12px;color:var(--muted)
    }
    .btn{
      display:inline-block;padding:6px 10px;border-radius:8px;border:1px solid var(--border);
      background:#fff;text-decoration:none;color:var(--ink);font-size:13px
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="logos">
        <div class="logo" id="logoPrimary"><span>CSA</span></div>
        <div class="logo" id="logoSecondary" style="display:none"></div>
      </div>
      <div>
        <div class="title" id="brandTitle">Correções — Reports</div>
        <div class="subtitle" id="brandSubtitle">Relatórios com rubrica</div>
      </div>
      <div class="meta" id="meta"></div>
    </div>

    <div class="main">
      <iframe id="view" src="about:blank" referrerpolicy="no-referrer"></iframe>
    </div>

    <div class="bar">
      <a class="btn" href="/index.html">← Voltar à lista</a>
      <span id="fileName" style="margin-left:12px"></span>
    </div>
  </div>

  <script>
    // 1) Carrega configuração de branding
    async function loadBranding(){
      try{
        const res = await fetch('/branding/config.json', {cache:'no-store'});
        if(!res.ok) throw new Error('config não encontrado');
        const cfg = await res.json();

        // Cores
        if(cfg.accentColor) document.documentElement.style.setProperty('--brand', cfg.accentColor);
        if(cfg.background)  document.documentElement.style.setProperty('--bg', cfg.background);
        if(cfg.textColor)   document.documentElement.style.setProperty('--ink', cfg.textColor);
        if(cfg.mutedColor)  document.documentElement.style.setProperty('--muted', cfg.mutedColor);
        if(cfg.cardColor)   document.documentElement.style.setProperty('--card', cfg.cardColor);
        if(cfg.borderColor) document.documentElement.style.setProperty('--border', cfg.borderColor);

        // Títulos
        document.getElementById('brandTitle').textContent   = cfg.brandTitle || 'Correções — Reports';
        document.getElementById('brandSubtitle').textContent= cfg.brandSubtitle || 'Relatórios com rubrica';

        // Logos
        const p = document.getElementById('logoPrimary');
        const s = document.getElementById('logoSecondary');

        if(cfg.primaryLogo){
          p.innerHTML = `<img alt="logo principal" src="${cfg.primaryLogo}">`;
        }
        if(cfg.secondaryLogo){
          s.style.display = '';
          s.innerHTML = `<img alt="logo secundário" src="${cfg.secondaryLogo}">`;
        }
      }catch(e){
        // Mantém defaults se não houver config
        console.warn('Branding default em uso:', e.message);
      }
    }

    // 2) Lê ?file=reports/xxx.html e mostra no iframe
    function openReportFromQuery(){
      const params = new URLSearchParams(location.search);
      const file = params.get('file');
      const frame = document.getElementById('view');
      const fileNameEl = document.getElementById('fileName');

      if(!file){
        frame.srcdoc = `<div style="padding:24px;font:14px system-ui">
          <h3>Arquivo não informado</h3>
          <p>Use a lista em <a href="/index.html">/index.html</a> para abrir um relatório.</p>
        </div>`;
        return;
      }

      // Nome amigável no rodapé
      try{
        const nice = decodeURIComponent(file).split('/').pop();
        fileNameEl.textContent = 'Arquivo: ' + nice;
      }catch(e){ fileNameEl.textContent = 'Arquivo: ' + file; }

      // Carrega o relatório real
      frame.src = '/' + file.replace(/^\/+/, '');
    }

    // 3) Data/hora
    document.getElementById('meta').textContent = new Date().toLocaleString('pt-BR');

    // Inicialização
    loadBranding().then(openReportFromQuery);
  </script>
</body>
</html>
